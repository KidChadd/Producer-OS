# ‚úÖ FINAL AGENT MODE PROMPT ‚Äî Producer OS v2

## Hybrid WAV Classification (Folder + Filename + Waveform + Pitch Tracking + Glide)

### Deterministic ‚Ä¢ Logged ‚Ä¢ Idempotent ‚Ä¢ Safe ‚Ä¢ Tunable

You are an implementation agent working on **Producer OS v2**.

You must implement **hybrid audio classification** for **WAV files only** using:

1. **Parent folder name hints**
2. **Filename hints**
3. **Waveform + spectral features**
4. **Advanced pitch tracking + glide detection**

The output must be **deterministic**, **explainable**, **logged**, **idempotent**, and **safe**.

---

## üîí HARD RULES (NON-NEGOTIABLE)

1. **WAV ONLY**: Only analyze/classify `.wav`. Ignore everything else.
2. **No ML / no training / no randomness**.
3. **Never delete or modify audio files**.
4. **Never create per-file `.nfo`** (no `.nfo` next to WAVs).
5. **Do NOT invent or rename bucket IDs**. Use the fixed bucket IDs already in the project.
6. **Always choose best bucket** even if confidence is low ‚Äî but **mark low confidence** and show top candidates.
7. **Idempotent**: second run must not duplicate actions or create ‚Äú(2)‚Äù spam.
8. **Engine owns logic**; keep UI thin; do not push scoring logic into UI.
9. **Full reasoning in report**: every file must log folder hits, filename hits, audio features, pitch features, scores, confidence, and top candidates.

---

## ‚úÖ REQUIRED OUTPUT BEHAVIOR

* The engine must correctly classify 808s when:

  * filename is unhelpful (`01.wav`)
  * parent folder includes `808` (or equivalent bucket keyword)
  * waveform indicates long low-frequency tonal sustain
  * pitch tracking indicates low median f0 and/or glide

* **808 is a single bucket** (`808s`) ‚Äî do not split into Bass.

---

# ‚öôÔ∏è IMPLEMENTATION PROCESS (STRICT)

Before coding:

1. Inspect repo structure. Confirm where engine classification currently happens.
2. Identify the existing bucket IDs and keyword lists already used.
3. Propose a short checklist change-set + test plan.
   Then implement.

---

# ‚öôÔ∏è REQUIRED ‚ÄúTUNING CONSTANTS‚Äù SECTION (MANDATORY)

Create a single tuning block at the top of the engine file (or existing constants location if repo already has it).
No magic numbers in scoring functions.

Must include (defaults shown):

```text
FOLDER_HINT_WEIGHT = 50
FILENAME_HINT_WEIGHT = 25
FOLDER_HINT_CAP = 80
FILENAME_HINT_CAP = 40

LOW_CONFIDENCE_THRESHOLD = 0.75
PARENT_FOLDER_LEVELS_TO_SCAN = 5

FEATURE_THRESHOLDS = {
  808_duration_min: 0.45,
  kick_duration_max: 0.35,
  lowfreq_ratio_808: 0.60,
  lowfreq_ratio_hat_max: 0.20,
  centroid_bright: 4000,
  centroid_low: 300,
  transient_kick_min: 3.0,
  zcr_tonal_max: 0.08
}

AUDIO_WEIGHTS = {
  duration: 10,
  lowfreq: 15,
  centroid: 10,
  transient: 20,
  zcr: 10,
  flatness: 10
}

PITCH_WEIGHTS = {
  median_f0_low: 20,
  voiced_ratio: 10,
  glide_bonus: 10,
  stability_bonus: 10
}
```

### Future-proofing requirement

If `tuning.json` exists in config folder, allow it to override defaults.
But tuning.json must be optional (do not require it).

---

# 1) FOLDER HINT SCORING (DETERMINISTIC)

Scan last `PARENT_FOLDER_LEVELS_TO_SCAN` parent folder names above the file path.

Normalize by:

* lower-case
* also split tokens on `space`, `_`, `-`

For each bucket keyword match:

* `folder_hint_score[bucket] += FOLDER_HINT_WEIGHT`
* cap: `min(score, FOLDER_HINT_CAP)`

Folder hints are strong but not absolute; audio must be able to override.

---

# 2) FILENAME HINT SCORING (DETERMINISTIC)

Lowercase filename. For each bucket keyword match:

* `filename_hint_score[bucket] += FILENAME_HINT_WEIGHT`
* cap: `min(score, FILENAME_HINT_CAP)`

---

# 3) AUDIO FEATURE MATH (WAV ONLY)

## Core definitions

If stereo: `x = 0.5*(L+R)`
Analysis normalization only: `x_norm = x / (max(|x|) + eps)` where `eps=1e-9`

Frame params:

* `win=2048`, `hop=512`, Hann window

### 3.1 duration_seconds

`duration_seconds = N / sr`

### 3.2 RMS

Global: `rms = sqrt(mean(x_norm^2))`
Frame RMS: `rms_k = sqrt(mean(frame^2))`

### 3.3 transient_strength (critical)

Early window: first `T_EARLY=0.08s`
Mid window: next `T_MID=0.20s`

Convert to frames:

* `K_early = ceil(T_EARLY*sr/hop)`
* `K_mid = ceil(T_MID*sr/hop)`

Compute:

* `peak_early = max(rms_k[0:K_early])`
* `median_mid = median(rms_k[K_early:K_early+K_mid])`

Transient:
`transient_strength = peak_early / (median_mid + eps)`

### 3.4 spectral centroid

For each frame magnitude spectrum `X_k = |FFT(Hann(frame))|` with bin freqs `f_i`:

`centroid_k = sum(f_i * X_k[i]) / (sum(X_k[i]) + eps)`

* `centroid_mean = mean(centroid_k)`
* `centroid_early = mean(centroid_k[first 0.10s])`

### 3.5 low_freq_energy_ratio (808 detector)

Power spectrum: `P_k[i] = X_k[i]^2`

`P_total = sum(P_k)` over all i,k
`P_low = sum(P_k[i])` where `f_i < 120 Hz`

`low_freq_ratio = P_low / (P_total + eps)`

### 3.6 zero_crossing_rate

Per frame:
`zcr_k = (1/(win-1)) * count(sign changes)`
Global:
`zcr_mean = mean(zcr_k)`

### 3.7 spectral flatness

Per frame:
`flatness_k = geometric_mean(P_k) / (arithmetic_mean(P_k) + eps)`
Global:
`flatness_mean = mean(flatness_k)`

---

# 4) ADVANCED PITCH TRACKING (REQUIRED)

Use deterministic method (prefer librosa `yin`).

Compute per frame:

* `f0_k` Hz (invalid => NaN)

Voiced:

* `V = valid f0 frames`

`voiced_ratio = |V| / total_frames`
`median_f0 = median(f0_k over V)`
Stability:

* convert to semitones: `s_k = 12*log2(f0_k/f_ref)` with `f_ref=55Hz`
* `s_std = std(s_k over V)`

If pitch tracking fails:

* do not crash
* set pitch_available=false
* continue without pitch features

---

# 5) GLIDE DETECTION (REQUIRED, ROBUST)

Guardrails:

* duration >= 0.35s
* voiced_ratio >= 0.35
* enough usable frames >= 15

Convert voiced frames to semitones:
`s_k = 12*log2(f0_k/f_ref)`

Smooth:

* median filter window 5 frames
* then mean filter window 5 frames

Trim:

* remove first 10% and last 10% of voiced frames

Robust slope (Theil‚ÄìSen):
`m = median( (s_j - s_i) / (t_j - t_i) )`

Drop:

* `S_start = median(first 20% of usable s_u)`
* `S_end = median(last 20% of usable s_u)`
* `drop_st = S_start - S_end`

Residual MAD:

* fit line `s_hat(t)=m*t + b`, b = median(s_u - m*t_u)
* residuals `r_i = s_u[i] - s_hat(t_u[i])`
* `mad = median(|r_i|)`

Glide decision:

* `drop_st >= 1.0`
* `m <= -2.0 st/sec`
* `mad <= 0.35`

Glide confidence:
A = clamp(drop_st/6,0,1)
B = clamp((-m)/10,0,1)
C = clamp((voiced_ratio-0.35)/0.35,0,1)
D = clamp((0.35-mad)/0.35,0,1)

`confidence_glide = 0.35A + 0.25B + 0.20C + 0.20D`

---

# 6) BUCKET SCORING RULES (DETERMINISTIC, WEIGHTED)

Total:
`score[b] = folder_hint[b] + filename_hint[b] + audio_score[b] + pitch_score[b]`

### 6.1 808s (single bucket)

Add:

* if duration > 0.45 ‚Üí +AUDIO_WEIGHTS.duration
* if low_freq_ratio > 0.60 ‚Üí +AUDIO_WEIGHTS.lowfreq
* if centroid_mean < 300 ‚Üí +AUDIO_WEIGHTS.centroid
* if zcr_mean < 0.08 ‚Üí +AUDIO_WEIGHTS.zcr
  Pitch:
* if median_f0 in 30..100 ‚Üí +PITCH_WEIGHTS.median_f0_low
* if voiced_ratio >= 0.5 ‚Üí +PITCH_WEIGHTS.voiced_ratio
* if glide_detected ‚Üí +(PITCH_WEIGHTS.glide_bonus * confidence_glide)
* if s_std small (stable) ‚Üí +PITCH_WEIGHTS.stability_bonus

### 6.2 Kicks

* if duration < 0.35 ‚Üí +AUDIO_WEIGHTS.duration
* if transient_strength > 3.0 ‚Üí +AUDIO_WEIGHTS.transient
* if centroid_early high (tune threshold) ‚Üí +AUDIO_WEIGHTS.centroid
* if voiced_ratio low (<0.25) ‚Üí small bonus (optional)

### 6.3 HiHats/Cymbals

* centroid_mean > 4000 ‚Üí +AUDIO_WEIGHTS.centroid
* low_freq_ratio < 0.20 ‚Üí +AUDIO_WEIGHTS.lowfreq
* duration short ‚Üí +AUDIO_WEIGHTS.duration
* flatness high ‚Üí +AUDIO_WEIGHTS.flatness

### 6.4 Snares/Claps

* flatness moderate-high AND zcr_mean high ‚Üí +flatness/zcr bonuses
* transient_strength moderate-high ‚Üí +transient
* centroid_mean moderate band ‚Üí +centroid band bonus

All thresholds must come from FEATURE_THRESHOLDS.

---

# 7) CONFIDENCE + LOW CONFIDENCE FLAG

Sort buckets by score descending.

Let top 3 scores be `s1,s2,s3`.

Confidence ratio:
`confidence_ratio = s1 / max(1, s1+s2+s3)`

Margin:
`confidence_margin = s1 - s2`

Low confidence:
`low_confidence = (confidence_ratio < LOW_CONFIDENCE_THRESHOLD)`

Always choose best bucket regardless.

---

# 8) REPORTING REQUIREMENTS (MANDATORY)

Each WAV entry in `run_report.json` must include:

* `bucket` (best bucket)
* `confidence_ratio`, `confidence_margin`, `low_confidence`
* `candidates`: top 3 buckets with scores
* `reasons`:

  * folder_matches (which parent folders/keywords matched)
  * filename_matches
  * audio_summary (features computed)
  * pitch_summary (median_f0, voiced_ratio, s_std, pitch_available)
  * glide_summary (drop_st, slope, mad, confidence_glide, glide_detected)

Do not spam console; keep full detail in report/logs.

---

# 9) FEATURE CACHING (MANDATORY)

Create and use `feature_cache.json`.

Cache key must include:

* absolute path string
* file size bytes
* modified time

Key:
`k = "{path}|{size}|{mtime}"`

Cache:
`cache[k] = feature_dict`

Reuse cached features if key matches.

---

# 10) REQUIRED TESTS (MANDATORY)

Create tests that synthesize WAVs (math-defined):

1. Folder hint: file named `01.wav` inside folder containing ‚Äú808s‚Äù must strongly score 808s.
2. Audio override: kick-like transient sample inside folder ‚Äú808s‚Äù must score Kicks if evidence strong enough.
3. Tonal glide: decaying sine around 50‚Äì65Hz with downward glide must score 808s and glide_detected=true.
4. Low confidence marking: ambiguous sample must still pick best bucket but low_confidence=true and include top 3 candidates.
5. Idempotency: two runs in a row must not duplicate actions.

---

# ‚úÖ ACCEPTANCE CHECKLIST (PASS/FAIL)

The implementation is accepted only if:

* [ ] Only `.wav` files are analyzed/classified.
* [ ] `01.wav` under an ‚Äú808s‚Äù folder routes to 808s via folder hints.
* [ ] Kick-like transient can override folder hint if strongly contradictory.
* [ ] Pitch tracking runs deterministically, with safe fallback.
* [ ] Glide detection returns correct drop/slope/mad and doesn‚Äôt false-positive on kicks.
* [ ] Every file includes top 3 candidates, scores, confidence, and reason breakdown.
* [ ] Feature caching prevents re-analysis of unchanged files.
* [ ] Tests cover all 5 required cases.
* [ ] Second run is idempotent (no duplicates, no spam).
* [ ] No per-file `.nfo` is created and no audio is modified.

---
