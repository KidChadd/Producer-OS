name: Auto Version

on:
  push:
    branches: ["main"]

concurrency:
  group: auto-version-main
  cancel-in-progress: true

permissions:
  actions: write
  contents: write

env:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"

jobs:
  version:
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    env:
      SEMANTIC_RELEASE_GH_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN != '' && secrets.SEMANTIC_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
      HAS_SEMANTIC_RELEASE_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN != '' }}

    steps:
      - name: Checkout full history
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          token: ${{ secrets.SEMANTIC_RELEASE_TOKEN != '' && secrets.SEMANTIC_RELEASE_TOKEN || secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: pyproject.toml

      - name: Install semantic-release
        run: |
          python -m pip install --upgrade pip
          python -m pip install -c .github/constraints/ci-tools.txt python-semantic-release
          semantic-release --version

      - name: Report versioning auth mode
        shell: bash
        run: |
          if [ "$HAS_SEMANTIC_RELEASE_TOKEN" = "true" ]; then
            echo "Using SEMANTIC_RELEASE_TOKEN for semantic-release push and workflow dispatch."
          else
            echo "::warning::Using GITHUB_TOKEN. Protected 'main' with PR-required rules will reject semantic-release direct pushes (GH006). Add repository secret SEMANTIC_RELEASE_TOKEN (PAT or GitHub App token with bypass rights) or switch to a PR-based versioning flow."
          fi

      - name: Detect existing version tag on HEAD
        id: head_tag
        shell: bash
        run: |
          git fetch --tags --force
          TAG="$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)"
          if [ -n "$TAG" ]; then
            echo "has_tag=true" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "Version tag already exists on HEAD ($TAG); skipping semantic-release."
          else
            echo "has_tag=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run semantic versioning (create/update tag)
        if: steps.head_tag.outputs.has_tag != 'true'
        env:
          GH_TOKEN: ${{ env.SEMANTIC_RELEASE_GH_TOKEN }}
        run: |
          semantic-release version

      - name: Resolve version tag on HEAD
        id: release_tag
        shell: bash
        run: |
          git fetch --tags --force
          TAG="$(git tag --points-at HEAD | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 1 || true)"
          if [ -n "$TAG" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "tag=$TAG" >> "$GITHUB_OUTPUT"
            echo "Resolved release tag on HEAD: $TAG"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No version tag on HEAD; nothing to dispatch."
          fi

      - name: Trigger Windows release workflow
        if: steps.head_tag.outputs.has_tag != 'true' && steps.release_tag.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ env.SEMANTIC_RELEASE_GH_TOKEN }}
        run: |
          gh workflow run release.yml --ref main -f tag=${{ steps.release_tag.outputs.tag }}

