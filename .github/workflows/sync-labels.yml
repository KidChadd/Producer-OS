name: Sync Labels

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - ".github/labels.json"
      - ".github/workflows/sync-labels.yml"

permissions:
  contents: read
  issues: write
  pull-requests: write

concurrency:
  group: sync-labels-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Sync repository labels
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require("fs");
            const path = ".github/labels.json";
            const raw = fs.readFileSync(path, "utf8");
            const labels = JSON.parse(raw);
            if (!Array.isArray(labels)) {
              throw new Error(`${path} must be a JSON array`);
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const existing = await github.paginate(
              github.rest.issues.listLabelsForRepo,
              { owner, repo, per_page: 100 }
            );
            const existingMap = new Map(existing.map((l) => [l.name, l]));

            let created = 0;
            let updated = 0;

            for (const label of labels) {
              if (!label.name || !label.color) {
                throw new Error(`Invalid label entry: ${JSON.stringify(label)}`);
              }
              const color = String(label.color).replace(/^#/, "");
              const description = label.description ? String(label.description) : "";

              if (existingMap.has(label.name)) {
                await github.rest.issues.updateLabel({
                  owner,
                  repo,
                  name: label.name,
                  color,
                  description,
                });
                updated += 1;
                core.info(`Updated label: ${label.name}`);
              } else {
                await github.rest.issues.createLabel({
                  owner,
                  repo,
                  name: label.name,
                  color,
                  description,
                });
                created += 1;
                core.info(`Created label: ${label.name}`);
              }
            }

            core.info(`Label sync complete. created=${created} updated=${updated}`);
