name: Release (Windows Portable + Installer)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  release-windows:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python deps
        shell: pwsh
        run: |
          python -m pip install -U pip setuptools wheel
          python -m pip install "nuitka==2.8.10"
          pip install -e ".[dev]"
          python -m pip install PySide6

      - name: Lint + tests
        shell: pwsh
        run: |
          ruff check src tests
          pytest -q --disable-warnings

      - name: Build Portable (Nuitka standalone)
        shell: pwsh
        run: |
          if (Test-Path dist) { Remove-Item -Recurse -Force dist }
          if (Test-Path build_gui_entry.build) { Remove-Item -Recurse -Force build_gui_entry.build }

          python -m nuitka `
            --standalone `
            --enable-plugin=pyside6 `
            --windows-console-mode=disable `
            --output-dir=dist `
            --output-filename=ProducerOS `
            build_gui_entry.py

          if (!(Test-Path "dist\build_gui_entry.dist\ProducerOS.exe")) {
            Write-Host "ProducerOS.exe not found."
            Get-ChildItem dist -Recurse | Select-Object FullName
            exit 1
          }

      - name: Zip Portable build
        shell: pwsh
        run: |
          $zip = "ProducerOS-Windows-Portable.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path "dist\build_gui_entry.dist\*" -DestinationPath $zip -Force

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build Installer (Inno Setup)
        shell: pwsh
        run: |
          $iss = "producer_os\producer_os_installer.iss"
          if (!(Test-Path $iss)) { throw "Installer script not found: $iss" }

          iscc $iss

          # Find the newest installer exe produced by Inno
          $installer = Get-ChildItem -Recurse -Filter *.exe |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1 -ExpandProperty FullName

          Copy-Item $installer "ProducerOS-Setup.exe" -Force

      - name: Create GitHub Release + upload assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ProducerOS-Windows-Portable.zip
            ProducerOS-Setup.exe